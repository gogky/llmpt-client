version: '3.8'

services:
  seeder:
    build: 
      context: .
      dockerfile: tests/integration/docker/Dockerfile.test
    container_name: llmpt-seeder
    volumes:
      - .:/app
    environment:
      - HF_HOME=/app/tests/integration/docker/hf_cache_seeder
      - ROLE=seeder
      - TRACKER_URL=http://118.195.159.242
    network_mode: bridge
    command: ["python", "-m", "pytest", "tests/integration/docker/run_seeder.py", "--run-integration", "-s"]
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://118.195.159.242/api/v1/health')"]
      interval: 10s
      timeout: 5s
      retries: 3

  downloader:
    build:
      context: .
      dockerfile: tests/integration/docker/Dockerfile.test
    container_name: llmpt-downloader
    depends_on:
      seeder:
        condition: service_started
    volumes:
      - .:/app
    environment:
      - HF_HOME=/app/tests/integration/docker/hf_cache_downloader
      - ROLE=downloader
      - TRACKER_URL=http://118.195.159.242
    network_mode: bridge
    command: ["python", "-m", "pytest", "tests/integration/docker/test_docker_p2p.py", "--run-integration", "-v", "-s"]
